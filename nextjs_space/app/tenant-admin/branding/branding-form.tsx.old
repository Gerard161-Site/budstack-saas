
'use client';

import { useState } from 'react';
import { useRouter } from 'next/navigation';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Textarea } from '@/components/ui/textarea';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { RadioGroup, RadioGroupItem } from '@/components/ui/radio-group';
import { toast } from 'sonner';
import { Upload, Check } from 'lucide-react';

interface BrandingFormProps {
  tenant: {
    id: string;
    businessName: string;
    subdomain: string;
    customDomain: string | null;
    settings: any;
  };
}

const TEMPLATES = [
  { id: 'modern', name: 'Modern Cannabis', description: 'Clean and professional' },
  { id: 'minimalist', name: 'Minimalist', description: 'Simple and elegant' },
  { id: 'vibrant', name: 'Vibrant', description: 'Bold and colorful' },
];

const FONTS = [
  { id: 'inter', name: 'Inter', family: 'Inter, sans-serif' },
  { id: 'roboto', name: 'Roboto', family: 'Roboto, sans-serif' },
  { id: 'opensans', name: 'Open Sans', family: 'Open Sans, sans-serif' },
  { id: 'lato', name: 'Lato', family: 'Lato, sans-serif' },
  { id: 'montserrat', name: 'Montserrat', family: 'Montserrat, sans-serif' },
  { id: 'playfair', name: 'Playfair Display', family: 'Playfair Display, serif' },
];

export default function BrandingForm({ tenant }: BrandingFormProps) {
  const router = useRouter();
  const [isLoading, setIsLoading] = useState(false);
  const [logo, setLogo] = useState<File | null>(null);
  const [heroImage, setHeroImage] = useState<File | null>(null);
  const [heroVideo, setHeroVideo] = useState<File | null>(null);
  
  const settings = tenant.settings || {};
  const [formData, setFormData] = useState({
    businessName: tenant.businessName,
    tagline: settings.tagline || '',
    primaryColor: settings.primaryColor || '#10b981',
    secondaryColor: settings.secondaryColor || '#059669',
    accentColor: settings.accentColor || '#34d399',
    template: settings.template || 'modern',
    fontFamily: settings.fontFamily || 'inter',
    heroType: settings.heroType || 'image', // 'image' or 'video'
  });

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setIsLoading(true);

    try {
      const formDataToSend = new FormData();
      formDataToSend.append('businessName', formData.businessName);
      formDataToSend.append('tagline', formData.tagline);
      formDataToSend.append('primaryColor', formData.primaryColor);
      formDataToSend.append('secondaryColor', formData.secondaryColor);
      formDataToSend.append('accentColor', formData.accentColor);
      formDataToSend.append('template', formData.template);
      formDataToSend.append('fontFamily', formData.fontFamily);
      formDataToSend.append('heroType', formData.heroType);
      
      if (logo) {
        formDataToSend.append('logo', logo);
      }
      if (formData.heroType === 'image' && heroImage) {
        formDataToSend.append('heroImage', heroImage);
      }
      if (formData.heroType === 'video' && heroVideo) {
        formDataToSend.append('heroVideo', heroVideo);
      }

      const res = await fetch(`/api/tenant-admin/branding`, {
        method: 'POST',
        body: formDataToSend,
      });

      if (!res.ok) throw new Error('Failed to update branding');

      toast.success('Branding updated successfully');
      router.refresh();
    } catch (error) {
      toast.error('Failed to update branding');
      console.error(error);
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <form onSubmit={handleSubmit} className="space-y-6">
      {/* Business Info */}
      <Card>
        <CardHeader>
          <CardTitle>Business Information</CardTitle>
          <CardDescription>Update your store name and tagline</CardDescription>
        </CardHeader>
        <CardContent className="space-y-4">
          <div>
            <Label htmlFor="businessName">Business Name</Label>
            <Input
              id="businessName"
              value={formData.businessName}
              onChange={(e) => setFormData({ ...formData, businessName: e.target.value })}
              required
            />
          </div>
          <div>
            <Label htmlFor="tagline">Tagline</Label>
            <Textarea
              id="tagline"
              value={formData.tagline}
              onChange={(e) => setFormData({ ...formData, tagline: e.target.value })}
              placeholder="Your trusted medical cannabis partner"
              rows={2}
            />
          </div>
        </CardContent>
      </Card>

      {/* Template Selection */}
      <Card>
        <CardHeader>
          <CardTitle>Template Design</CardTitle>
          <CardDescription>Choose your store's template style</CardDescription>
        </CardHeader>
        <CardContent>
          <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
            {TEMPLATES.map((template) => (
              <div
                key={template.id}
                onClick={() => setFormData({ ...formData, template: template.id })}
                className={`relative p-4 border-2 rounded-lg cursor-pointer transition-all ${
                  formData.template === template.id
                    ? 'border-green-500 bg-green-50'
                    : 'border-gray-200 hover:border-gray-300'
                }`}
              >
                {formData.template === template.id && (
                  <div className="absolute top-2 right-2 bg-green-500 text-white rounded-full p-1">
                    <Check className="h-4 w-4" />
                  </div>
                )}
                <h3 className="font-semibold text-lg mb-1">{template.name}</h3>
                <p className="text-sm text-gray-600">{template.description}</p>
              </div>
            ))}
          </div>
        </CardContent>
      </Card>

      {/* Logo & Hero Media */}
      <Card>
        <CardHeader>
          <CardTitle>Logo & Hero Media</CardTitle>
          <CardDescription>Upload your logo and hero content</CardDescription>
        </CardHeader>
        <CardContent className="space-y-6">
          <div>
            <Label htmlFor="logo">Store Logo</Label>
            <div className="mt-2">
              <Input
                id="logo"
                type="file"
                accept="image/*"
                onChange={(e) => setLogo(e.target.files?.[0] || null)}
                className="cursor-pointer"
              />
            </div>
            <p className="text-xs text-gray-500 mt-1">Recommended: PNG or SVG, max 2MB</p>
          </div>

          <div>
            <Label>Hero Content Type</Label>
            <RadioGroup
              value={formData.heroType}
              onValueChange={(value) => setFormData({ ...formData, heroType: value })}
              className="flex gap-4 mt-2"
            >
              <div className="flex items-center space-x-2">
                <RadioGroupItem value="image" id="hero-image" />
                <Label htmlFor="hero-image" className="cursor-pointer">Image</Label>
              </div>
              <div className="flex items-center space-x-2">
                <RadioGroupItem value="video" id="hero-video" />
                <Label htmlFor="hero-video" className="cursor-pointer">Video</Label>
              </div>
            </RadioGroup>
          </div>

          {formData.heroType === 'image' && (
            <div>
              <Label htmlFor="heroImage">Hero Image</Label>
              <div className="mt-2">
                <Input
                  id="heroImage"
                  type="file"
                  accept="image/*"
                  onChange={(e) => setHeroImage(e.target.files?.[0] || null)}
                  className="cursor-pointer"
                />
              </div>
              <p className="text-xs text-gray-500 mt-1">Recommended: 1920x1080px, max 5MB</p>
            </div>
          )}

          {formData.heroType === 'video' && (
            <div>
              <Label htmlFor="heroVideo">Hero Video</Label>
              <div className="mt-2">
                <Input
                  id="heroVideo"
                  type="file"
                  accept="video/*"
                  onChange={(e) => setHeroVideo(e.target.files?.[0] || null)}
                  className="cursor-pointer"
                />
              </div>
              <p className="text-xs text-gray-500 mt-1">Recommended: MP4 format, max 20MB</p>
            </div>
          )}
        </CardContent>
      </Card>

      {/* Typography */}
      <Card>
        <CardHeader>
          <CardTitle>Typography</CardTitle>
          <CardDescription>Select your brand's font family</CardDescription>
        </CardHeader>
        <CardContent>
          <Label htmlFor="fontFamily">Font Family</Label>
          <Select value={formData.fontFamily} onValueChange={(value) => setFormData({ ...formData, fontFamily: value })}>
            <SelectTrigger id="fontFamily" className="mt-2">
              <SelectValue placeholder="Select a font" />
            </SelectTrigger>
            <SelectContent>
              {FONTS.map((font) => (
                <SelectItem key={font.id} value={font.id}>
                  <span style={{ fontFamily: font.family }}>{font.name}</span>
                </SelectItem>
              ))}
            </SelectContent>
          </Select>
        </CardContent>
      </Card>

      {/* Color Scheme */}
      <Card>
        <CardHeader>
          <CardTitle>Color Scheme</CardTitle>
          <CardDescription>Customize your store colors</CardDescription>
        </CardHeader>
        <CardContent className="space-y-4">
          <div className="grid grid-cols-3 gap-4">
            <div>
              <Label htmlFor="primaryColor">Primary Color</Label>
              <div className="flex gap-2 mt-2">
                <Input
                  id="primaryColor"
                  type="color"
                  value={formData.primaryColor}
                  onChange={(e) => setFormData({ ...formData, primaryColor: e.target.value })}
                  className="w-16 h-10"
                />
                <Input
                  type="text"
                  value={formData.primaryColor}
                  onChange={(e) => setFormData({ ...formData, primaryColor: e.target.value })}
                  className="flex-1"
                />
              </div>
            </div>
            <div>
              <Label htmlFor="secondaryColor">Secondary Color</Label>
              <div className="flex gap-2 mt-2">
                <Input
                  id="secondaryColor"
                  type="color"
                  value={formData.secondaryColor}
                  onChange={(e) => setFormData({ ...formData, secondaryColor: e.target.value })}
                  className="w-16 h-10"
                />
                <Input
                  type="text"
                  value={formData.secondaryColor}
                  onChange={(e) => setFormData({ ...formData, secondaryColor: e.target.value })}
                  className="flex-1"
                />
              </div>
            </div>
            <div>
              <Label htmlFor="accentColor">Accent Color</Label>
              <div className="flex gap-2 mt-2">
                <Input
                  id="accentColor"
                  type="color"
                  value={formData.accentColor}
                  onChange={(e) => setFormData({ ...formData, accentColor: e.target.value })}
                  className="w-16 h-10"
                />
                <Input
                  type="text"
                  value={formData.accentColor}
                  onChange={(e) => setFormData({ ...formData, accentColor: e.target.value })}
                  className="flex-1"
                />
              </div>
            </div>
          </div>
        </CardContent>
      </Card>

      {/* Submit */}
      <div className="flex justify-end">
        <Button type="submit" disabled={isLoading}>
          {isLoading ? 'Saving...' : 'Save Changes'}
        </Button>
      </div>
    </form>
  );
}
