generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-arm64-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model audit_logs {
  id         String   @id
  action     String
  entityType String
  entityId   String?
  userId     String?
  userEmail  String?
  tenantId   String?
  metadata   Json?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())

  @@index([action, createdAt])
  @@index([tenantId, createdAt])
  @@index([userId, createdAt])
}

model conditions {
  id              String   @id
  slug            String
  name            String
  description     String?
  image           String?
  category        String
  categoryKey     String
  causes          Json?
  symptoms        Json?
  types           Json?
  treatments      Json?
  medicalCannabis Json?
  faqs            Json?
  published       Boolean  @default(true)
  tenantId        String
  createdAt       DateTime @default(now())
  updatedAt       DateTime
  tenants         tenants  @relation(fields: [tenantId], references: [id])

  @@unique([tenantId, slug])
  @@index([tenantId])
}

model consultation_questionnaires {
  id                    String   @id
  tenantId              String?
  firstName             String
  lastName              String
  email                 String
  phoneCode             String
  phoneNumber           String
  dateOfBirth           DateTime
  gender                String
  password              String
  addressLine1          String
  addressLine2          String?
  city                  String
  state                 String
  postalCode            String
  country               String
  countryCode           String
  businessType          String?
  businessName          String?
  businessAddress1      String?
  businessAddress2      String?
  businessCity          String?
  businessState         String?
  businessPostalCode    String?
  businessCountry       String?
  businessCountryCode   String?
  medicalConditions     String[] @default([])
  otherCondition        String?
  prescribedMedications String[] @default([])
  prescribedSupplements String?
  hasHeartProblems      Boolean  @default(false)
  hasCancerTreatment    Boolean  @default(false)
  hasImmunosuppressants Boolean  @default(false)
  hasLiverDisease       Boolean  @default(false)
  hasPsychiatricHistory Boolean  @default(false)
  hasAlcoholAbuse       Boolean  @default(false)
  hasDrugServices       Boolean  @default(false)
  alcoholUnitsPerWeek   String?
  cannabisReducesMeds   Boolean  @default(false)
  cannabisFrequency     String?
  cannabisAmountPerDay  String?
  drGreenClientId       String?
  submittedToDrGreen    Boolean  @default(false)
  submissionError       String?
  kycLink               String?
  isKycVerified         Boolean  @default(false)
  adminApproval         String   @default("PENDING")
  createdAt             DateTime @default(now())
  updatedAt             DateTime
}

model consultations {
  id        String             @id
  userId    String
  tenantId  String
  status    ConsultationStatus @default(PENDING)
  createdAt DateTime           @default(now())
  updatedAt DateTime
  tenants   tenants            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  users     users              @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model drgreen_carts {
  id            String   @id
  userId        String   @unique
  tenantId      String
  drGreenCartId String?
  items         Json
  createdAt     DateTime @default(now())
  updatedAt     DateTime
  tenants       tenants  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  users         users    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, tenantId])
  @@index([tenantId])
}

model drgreen_webhook_logs {
  id             String    @id
  tenantId       String
  webhookType    String
  orderId        String?
  drGreenOrderId String?
  payload        Json
  processed      Boolean   @default(false)
  processedAt    DateTime?
  error          String?
  createdAt      DateTime  @default(now())
  tenants        tenants   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([drGreenOrderId])
  @@index([tenantId, processed])
}

model order_items {
  id          String   @id
  orderId     String
  productId   String
  productName String
  quantity    Int
  price       Float
  createdAt   DateTime @default(now())
  orders      orders   @relation(fields: [orderId], references: [id], onDelete: Cascade)
}

model orders {
  id                String        @id
  userId            String
  tenantId          String
  total             Float
  createdAt         DateTime      @default(now())
  updatedAt         DateTime
  notes             String?
  adminNotes        String?
  orderNumber       String        @unique
  shippingCost      Float         @default(5.00)
  shippingInfo      Json?
  subtotal          Float
  status            OrderStatus   @default(PENDING)
  drGreenOrderId    String?
  drGreenInvoiceNum String?
  paymentStatus     PaymentStatus @default(PENDING)
  paymentInvoices   Json?
  nonce             String?
  order_items       order_items[]
  tenants           tenants       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  users             users         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([drGreenOrderId])
  @@index([nonce])
}

model platform_config {
  id                 String   @id @default("config")
  drGreenApiUrl      String?
  awsBucketName      String?
  awsFolderPrefix    String?
  awsRegion          String?
  awsAccessKeyId     String?
  awsSecretAccessKey String?
  emailServer        String?
  emailFrom          String?
  redisUrl           String?
  updatedAt          DateTime
  createdAt          DateTime @default(now())
}

model platform_settings {
  id                String   @id @default("platform")
  businessName      String   @default("BudStack")
  tagline           String?
  logoUrl           String?
  faviconUrl        String?
  primaryColor      String   @default("#059669")
  secondaryColor    String   @default("#34d399")
  accentColor       String   @default("#10b981")
  backgroundColor   String   @default("#ffffff")
  textColor         String   @default("#1f2937")
  headingColor      String   @default("#111827")
  fontFamily        String   @default("inter")
  headingFontFamily String   @default("inter")
  template          String   @default("modern")
  updatedAt         DateTime
}

model posts {
  id         String   @id
  title      String
  slug       String
  content    String
  excerpt    String?
  coverImage String?
  published  Boolean  @default(false)
  tenantId   String
  authorId   String
  createdAt  DateTime @default(now())
  updatedAt  DateTime
  users      users    @relation(fields: [authorId], references: [id])
  tenants    tenants  @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([slug, tenantId])
}

model products {
  id           String      @id
  name         String
  slug         String
  description  String?
  category     String
  strainType   StrainType?
  thcContent   Float?
  cbdContent   Float?
  price        Float
  stock        Int         @default(0)
  images       String[]
  displayOrder Int         @default(0)
  tenantId     String
  createdAt    DateTime    @default(now())
  updatedAt    DateTime
  tenants      tenants     @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([slug, tenantId])
}

model templates {
  id               String             @id
  name             String
  description      String?
  isActive         Boolean            @default(true)
  isPublic         Boolean            @default(true)
  ownerId          String?
  sourceType       String             @default("SYSTEM")
  createdAt        DateTime           @default(now())
  updatedAt        DateTime
  assetsPath       String?
  author           String?
  category         String             @default("modern")
  componentsPath   String?
  demoUrl          String?
  downloadCount    Int                @default(0)
  isPremium        Boolean            @default(false)
  layoutFilePath   String?
  metadata         Json?
  packagePath      String?
  previewUrl       String?
  price            Float?
  slug             String?            @unique
  stylesPath       String?
  tags             String[]
  thumbnailUrl     String?
  usageCount       Int                @default(0)
  version          String             @default("1.0.0")
  tenant_templates tenant_templates[]
  tenants          tenants[]
}

model tenant_branding {
  id             String   @id
  tenantId       String   @unique
  logoUrl        String?
  faviconUrl     String?
  primaryColor   String   @default("#10b981")
  secondaryColor String   @default("#059669")
  accentColor    String   @default("#34d399")
  fontFamily     String   @default("Inter")
  createdAt      DateTime @default(now())
  updatedAt      DateTime
  tenants        tenants  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
}

model tenant_templates {
  id                                                       String    @id
  tenantId                                                 String
  baseTemplateId                                           String
  templateName                                             String
  s3Path                                                   String?
  designSystem                                             Json?
  pageContent                                              Json?
  navigation                                               Json?
  footer                                                   Json?
  logoUrl                                                  String?
  heroImageUrl                                             String?
  faviconUrl                                               String?
  customCss                                                String?
  customJs                                                 String?
  isActive                                                 Boolean   @default(true)
  isDraft                                                  Boolean   @default(false)
  expiresAt                                                DateTime?
  createdAt                                                DateTime  @default(now())
  updatedAt                                                DateTime
  templates                                                templates @relation(fields: [baseTemplateId], references: [id])
  tenant                                                   tenants   @relation("tenant_templates_tenantIdTotenants", fields: [tenantId], references: [id], onDelete: Cascade)
  activeForTenant                                          tenants?  @relation("tenants_activeTenantTemplateIdTotenant_templates")

  @@unique([tenantId, templateName])
  @@index([tenantId, isActive])
}

model tenants {
  id                                                                String                 @id
  businessName                                                      String
  subdomain                                                         String                 @unique
  customDomain                                                      String?                @unique
  nftTokenId                                                        String?
  isActive                                                          Boolean                @default(false)
  settings                                                          Json?
  createdAt                                                         DateTime               @default(now())
  updatedAt                                                         DateTime
  countryCode                                                       String                 @default("PT")
  templateId                                                        String?
  activeTenantTemplateId                                            String?                @unique
  drGreenApiUrl                                                     String?
  drGreenApiKey                                                     String?
  drGreenSecretKey                                                  String?
  conditions                                                        conditions[]
  consultations                                                     consultations[]
  drgreen_carts                                                     drgreen_carts[]
  drgreen_webhook_logs                                              drgreen_webhook_logs[]
  orders                                                            orders[]
  posts                                                             posts[]
  products                                                          products[]
  tenant_branding                                                   tenant_branding?
  tenantTemplates                                                   tenant_templates[]     @relation("tenant_templates_tenantIdTotenants")
  activeTenantTemplate                                              tenant_templates?      @relation("tenants_activeTenantTemplateIdTotenant_templates", fields: [activeTenantTemplateId], references: [id])
  template                                                          templates?             @relation(fields: [templateId], references: [id])
  users                                                             users[]
}

model users {
  id               String          @id
  email            String          @unique
  password         String
  name             String?
  role             Role            @default(PATIENT)
  tenantId         String?
  drGreenClientId  String?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime
  resetToken       String?         @unique
  resetTokenExpiry DateTime?
  firstName        String?
  lastName         String?
  phone            String?
  address          Json?
  isActive         Boolean         @default(true)
  consultations    consultations[]
  drgreen_carts    drgreen_carts?
  orders           orders[]
  posts            posts[]
  tenants          tenants?        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
}

model webhook_deliveries {
  id           String    @id
  webhookId    String
  event        String
  payload      Json
  statusCode   Int?
  response     String?
  success      Boolean   @default(false)
  attemptCount Int       @default(1)
  nextRetry    DateTime?
  createdAt    DateTime  @default(now())
  webhooks     webhooks  @relation(fields: [webhookId], references: [id], onDelete: Cascade)

  @@index([success, nextRetry])
  @@index([webhookId, createdAt])
}

model webhooks {
  id                 String               @id
  tenantId           String?
  url                String
  events             String[]
  secret             String
  isActive           Boolean              @default(true)
  description        String?
  createdAt          DateTime             @default(now())
  updatedAt          DateTime
  webhook_deliveries webhook_deliveries[]

  @@index([tenantId])
}

enum ConsultationStatus {
  PENDING
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  EXPIRED
  CANCELLED
  OVERPAID
  UNDERPAID
}

enum Role {
  PATIENT
  TENANT_ADMIN
  SUPER_ADMIN
}

enum StrainType {
  SATIVA
  INDICA
  HYBRID
}
