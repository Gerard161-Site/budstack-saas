generator client {
    provider = "prisma-client-js"
    binaryTargets = ["native", "linux-musl-arm64-openssl-3.0.x"]
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

model Tenant {
  id                      String              @id @default(cuid())
  businessName            String
  subdomain               String              @unique
  customDomain            String?             @unique
  nftTokenId              String?
  isActive                Boolean             @default(false)
  settings                Json?
  createdAt               DateTime            @default(now())
  updatedAt               DateTime            @updatedAt
  countryCode             String              @default("PT")
  templateId              String?
  activeTenantTemplateId  String?             @unique
  drGreenApiUrl           String?
  drGreenApiKey           String?
  drGreenSecretKey        String?
  consultations           Consultation[]
  orders                  Order[]
  products                Product[]
  branding                TenantBranding?
  template                Template?           @relation(fields: [templateId], references: [id])
  tenantTemplates         TenantTemplate[]
  activeTenantTemplate    TenantTemplate?     @relation("ActiveTemplate", fields: [activeTenantTemplateId], references: [id])
  users                   User[]
  posts                   Post[]
  drGreenCarts            DrGreenCart[]
  drGreenWebhookLogs      DrGreenWebhookLog[]
  conditions              Condition[]

  @@map("tenants")
}

model TenantBranding {
  id             String   @id @default(cuid())
  tenantId       String   @unique
  logoUrl        String?
  faviconUrl     String?
  primaryColor   String   @default("#10b981")
  secondaryColor String   @default("#059669")
  accentColor    String   @default("#34d399")
  fontFamily     String   @default("Inter")
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  tenant         Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("tenant_branding")
}

model User {
  id               String         @id @default(cuid())
  email            String         @unique
  password         String
  name             String?
  role             Role           @default(PATIENT)
  tenantId         String?
  drGreenClientId  String?        // Client ID from Dr. Green API for cart/orders
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  resetToken       String?        @unique
  resetTokenExpiry DateTime?
  consultations    Consultation[]
  orders           Order[]
  posts            Post[]
  drGreenCart      DrGreenCart?
  tenant           Tenant?        @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("users")
}

model Product {
  id          String      @id @default(cuid())
  name        String
  slug        String
  description String?
  category    String
  strainType  StrainType?
  thcContent  Float?
  cbdContent  Float?
  price       Float
  stock       Int         @default(0)
  images      String[]
  tenantId    String
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  tenant      Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([slug, tenantId])
  @@map("products")
}

model Order {
  id                String        @id @default(cuid())
  userId            String
  tenantId          String
  total             Float
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  notes             String?
  orderNumber       String        @unique @default(cuid())
  shippingCost      Float         @default(5.00)
  shippingInfo      Json?
  subtotal          Float
  status            OrderStatus   @default(PENDING)
  
  // Dr. Green Integration Fields
  drGreenOrderId    String?       // Order ID from Dr. Green API
  drGreenInvoiceNum String?       // Invoice number from Dr. Green
  paymentStatus     PaymentStatus @default(PENDING)
  paymentInvoices   Json?         // {tcn, usdt, eth, btc, fiat} payment URLs
  nonce             String?       // Unique nonce for fiat payment webhook lookup
  
  items             OrderItem[]
  tenant            Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user              User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([drGreenOrderId])
  @@index([nonce])
  @@map("orders")
}

model Post {
  id          String   @id @default(cuid())
  title       String
  slug        String
  content     String   @db.Text
  excerpt     String?
  coverImage  String?
  published   Boolean  @default(false)
  tenantId    String
  authorId    String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  author      User     @relation(fields: [authorId], references: [id])
  
  @@unique([slug, tenantId])
  @@map("posts")
}


model OrderItem {
  id          String   @id @default(cuid())
  orderId     String
  productId   String
  productName String
  quantity    Int
  price       Float
  createdAt   DateTime @default(now())
  order       Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@map("order_items")
}

model Consultation {
  id        String             @id @default(cuid())
  userId    String
  tenantId  String
  status    ConsultationStatus @default(PENDING)
  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt
  tenant    Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user      User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("consultations")
}

model ConsultationQuestionnaire {
  id                   String   @id @default(cuid())
  tenantId             String?
  
  // Contact Details
  firstName            String
  lastName             String
  email                String
  phoneCode            String
  phoneNumber          String
  dateOfBirth          DateTime
  gender               String
  password             String
  
  // Shipping Address
  addressLine1         String
  addressLine2         String?
  city                 String
  state                String
  postalCode           String
  country              String
  countryCode          String
  
  // Business Info (Optional)
  businessType         String?
  businessName         String?
  businessAddress1     String?
  businessAddress2     String?
  businessCity         String?
  businessState        String?
  businessPostalCode   String?
  businessCountry      String?
  businessCountryCode  String?
  
  // Medical Conditions (multi-select)
  medicalConditions    String[] @default([])
  otherCondition       String?
  prescribedMedications String[] @default([])
  prescribedSupplements String?
  
  // Medical History Part 1
  hasHeartProblems     Boolean  @default(false)
  hasCancerTreatment   Boolean  @default(false)
  hasImmunosuppressants Boolean  @default(false)
  hasLiverDisease      Boolean  @default(false)
  hasPsychiatricHistory Boolean  @default(false)
  
  // Medical History Part 2
  hasAlcoholAbuse      Boolean  @default(false)
  hasDrugServices      Boolean  @default(false)
  alcoholUnitsPerWeek  String?
  cannabisReducesMeds  Boolean  @default(false)
  cannabisFrequency    String?
  cannabisAmountPerDay String?
  
  // Submission tracking
  drGreenClientId      String?
  submittedToDrGreen   Boolean  @default(false)
  submissionError      String?
  
  // KYC and Verification tracking
  kycLink              String?
  isKycVerified        Boolean  @default(false)
  adminApproval        String   @default("PENDING") // PENDING, VERIFIED, REJECTED
  
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  @@map("consultation_questionnaires")
}

model PlatformSettings {
  id                String   @id @default("platform")
  businessName      String   @default("BudStack")
  tagline           String?
  logoUrl           String?
  faviconUrl        String?
  primaryColor      String   @default("#059669")
  secondaryColor    String   @default("#34d399")
  accentColor       String   @default("#10b981")
  backgroundColor   String   @default("#ffffff")
  textColor         String   @default("#1f2937")
  headingColor      String   @default("#111827")
  fontFamily        String   @default("inter")
  headingFontFamily String   @default("inter")
  template          String   @default("modern")
  updatedAt         DateTime @updatedAt

  @@map("platform_settings")
}

model PlatformConfig {
  id                 String   @id @default("config")
  
  // Dr. Green API Integration
  drGreenApiUrl      String?
  
  // AWS S3 Configuration (sensitive fields encrypted)
  awsBucketName      String?
  awsFolderPrefix    String?
  awsRegion          String?
  awsAccessKeyId     String?  // ENCRYPTED
  awsSecretAccessKey String?  // ENCRYPTED
  
  // Email Configuration (sensitive fields encrypted)
  emailServer        String?  // ENCRYPTED (full SMTP URL)
  emailFrom          String?
  
  // Redis Configuration (encrypted)
  redisUrl           String?  // ENCRYPTED
  
  updatedAt          DateTime @updatedAt
  createdAt          DateTime @default(now())

  @@map("platform_config")
}

model Template {
  id             String   @id @default(cuid())
  name           String
  description    String?
  isActive       Boolean  @default(true)
  isPublic       Boolean  @default(true)
  ownerId        String?
  sourceType     String   @default("SYSTEM")
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  assetsPath     String?
  author         String?
  category       String   @default("modern")
  componentsPath String?
  demoUrl        String?
  downloadCount  Int      @default(0)
  isPremium      Boolean  @default(false)
  layoutFilePath String?
  metadata       Json?
  packagePath    String?
  previewUrl     String?
  price          Float?
  slug           String?  @unique
  stylesPath     String?
  tags           String[]
  thumbnailUrl   String?
  usageCount     Int      @default(0)
  version        String   @default("1.0.0")
  tenants        Tenant[]
  tenantTemplates TenantTemplate[]

  @@map("templates")
}

model TenantTemplate {
  id                String    @id @default(cuid())
  tenantId          String
  baseTemplateId    String
  templateName      String
  s3Path            String?
  designSystem      Json?
  pageContent       Json?
  navigation        Json?
  footer            Json?
  logoUrl           String?
  heroImageUrl      String?
  faviconUrl        String?
  customCss         String?   @db.Text
  customJs          String?   @db.Text
  isActive          Boolean   @default(true)
  isDraft           Boolean   @default(false)
  expiresAt         DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  tenant            Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  baseTemplate      Template  @relation(fields: [baseTemplateId], references: [id])
  activeForTenant   Tenant?   @relation("ActiveTemplate")

  @@unique([tenantId, templateName])
  @@index([tenantId, isActive])
  @@map("tenant_templates")
}

model AuditLog {
  id          String   @id @default(cuid())
  action      String
  entityType  String
  entityId    String?
  userId      String?
  userEmail   String?
  tenantId    String?
  metadata    Json?
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime @default(now())

  @@index([tenantId, createdAt])
  @@index([userId, createdAt])
  @@index([action, createdAt])
  @@map("audit_logs")
}

model Webhook {
  id          String        @id @default(cuid())
  tenantId    String?
  url         String
  events      String[]
  secret      String
  isActive    Boolean       @default(true)
  description String?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  deliveries  WebhookDelivery[]

  @@index([tenantId])
  @@map("webhooks")
}

model WebhookDelivery {
  id           String   @id @default(cuid())
  webhookId    String
  event        String
  payload      Json
  statusCode   Int?
  response     String?
  success      Boolean  @default(false)
  attemptCount Int      @default(1)
  nextRetry    DateTime?
  createdAt    DateTime @default(now())
  webhook      Webhook  @relation(fields: [webhookId], references: [id], onDelete: Cascade)

  @@index([webhookId, createdAt])
  @@index([success, nextRetry])
  @@map("webhook_deliveries")
}

enum Role {
  PATIENT
  TENANT_ADMIN
  SUPER_ADMIN
}

enum StrainType {
  SATIVA
  INDICA
  HYBRID
}

enum ConsultationStatus {
  PENDING
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  EXPIRED
  CANCELLED
  OVERPAID
  UNDERPAID
}

// Dr. Green Cart Model - Syncs with Dr. Green API cart
model DrGreenCart {
  id            String   @id @default(cuid())
  userId        String   @unique
  tenantId      String
  drGreenCartId String?  // Cart ID from Dr. Green API
  items         Json     // [{strainId, quantity, size, strain: {name, price}}]
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant        Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  @@unique([userId, tenantId])
  @@index([tenantId])
  @@map("drgreen_carts")
}

// Dr. Green Webhook Log - Audit trail for payment webhooks
model DrGreenWebhookLog {
  id            String   @id @default(cuid())
  tenantId      String
  webhookType   String   // 'crypto' | 'fiat'
  orderId       String?  // Local order ID
  drGreenOrderId String? // Dr. Green order ID from webhook payload
  payload       Json     // Full webhook payload
  processed     Boolean  @default(false)
  processedAt   DateTime?
  error         String?  // Error message if processing failed
  createdAt     DateTime @default(now())
  
  tenant        Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  @@index([tenantId, processed])
  @@index([drGreenOrderId])
  @@map("drgreen_webhook_logs")
}

model Condition {
  id              String   @id @default(cuid())
  slug            String
  name            String
  description     String?  // Subtitle/Excerpt
  image           String?
  category        String   // Display name e.g "Mental Health"
  categoryKey     String   // Filter key e.g "mentalHealth"
  
  // Rich Content (JSON)
  causes          Json?    // Array of {title, desc}
  symptoms        Json?    // Object {physical: [], psychological: []}
  types           Json?    // Array of {type, desc}
  treatments      Json?    // Array of {title, desc}
  medicalCannabis Json?    // Object {content1, content2}
  faqs            Json?    // Array of {question, answer}
  
  published       Boolean  @default(true)
  
  // Relations
  tenantId        String
  tenant          Tenant   @relation(fields: [tenantId], references: [id])
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@unique([tenantId, slug])
  @@index([tenantId])
  @@map("conditions")
}
